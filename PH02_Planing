SELECT
  i.StockCode,
  i.Description,
  i.Unit,
  i.OUN,
  i.LT,
  i.Vendor,
  IFNULL(s.qty, 0) AS stock_qty,
  c.class,
  ROUND(c.usage_rate, 2) AS usage_rate,
  printf('%.2f', c.usage_rate) AS usage_rate_fmt,
  IFNULL(p.on_gr, 0) AS On_GR,

  -- ✅ DOH = (stock_qty + On_GR) / usage_rate → ปัดเศษ 0 ตำแหน่ง
  ROUND(
    (IFNULL(s.qty, 0) + IFNULL(p.on_gr, 0)) / NULLIF(c.usage_rate, 0),
    0
  ) AS DOH

FROM item_master i

-- JOIN stock
LEFT JOIN (
  SELECT stockcode, qty
  FROM stock
  WHERE location = 'ph02'
) s ON TRIM(i.StockCode) = TRIM(s.stockcode)

-- JOIN class + usage_rate
LEFT JOIN (
  SELECT stockcode, class, usage_rate
  FROM class_plan_from_nonmove
  WHERE location = 'ph02'
) c ON TRIM(i.StockCode) = TRIM(c.stockcode)

-- JOIN ponogr (On_GR)
LEFT JOIN (
  SELECT stockcode, SUM(qty) AS on_gr
  FROM ponogr
  GROUP BY stockcode
) p ON TRIM(i.StockCode) = TRIM(p.stockcode);
